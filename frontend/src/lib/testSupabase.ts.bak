import { SupabaseService } from './supabaseStore'
import { DataMigration } from './migration'

/**
 * Script de test pour vÃ©rifier la connexion Supabase
 */
export class SupabaseTest {
  /**
   * Teste la connexion Ã  Supabase
   */
  static async testConnection(): Promise<boolean> {
    try {
      console.log('ğŸ”Œ Test de connexion Ã  Supabase...')
      
      const companies = await SupabaseService.getCompanies()
      console.log(`âœ… Connexion rÃ©ussie! ${companies.length} entreprises trouvÃ©es.`)
      
      return true
    } catch (error) {
      console.error('âŒ Erreur de connexion:', error)
      return false
    }
  }

  /**
   * Teste la crÃ©ation d'une entreprise
   */
  static async testCreateCompany(): Promise<boolean> {
    try {
      console.log('ğŸ¢ Test de crÃ©ation d\'entreprise...')
      
      const testCompany = {
        name: 'Test Company',
        address: '123 Test Street',
        city: 'Test City',
        postal_code: '12345',
        phone: '+33 1 23 45 67 89',
        email: 'test@example.com',
        siret: '12345678901234'
      }

      const created = await SupabaseService.createCompany(testCompany)
      console.log('âœ… Entreprise crÃ©Ã©e:', created.id)
      
      // Nettoyer
      await SupabaseService.deleteCompany(created.id)
      console.log('âœ… Entreprise supprimÃ©e')
      
      return true
    } catch (error) {
      console.error('âŒ Erreur lors du test de crÃ©ation:', error)
      return false
    }
  }

  /**
   * Teste la migration complÃ¨te
   */
  static async testMigration(): Promise<boolean> {
    try {
      console.log('ğŸ“Š Test de migration...')
      
      const needsMigration = await DataMigration.isMigrationNeeded()
      if (!needsMigration) {
        console.log('â„¹ï¸ Migration dÃ©jÃ  effectuÃ©e')
        return true
      }

      await DataMigration.migrateAllData()
      console.log('âœ… Migration testÃ©e avec succÃ¨s')
      
      return true
    } catch (error) {
      console.error('âŒ Erreur lors de la migration:', error)
      return false
    }
  }

  /**
   * Lance tous les tests
   */
  static async runAllTests(): Promise<void> {
    console.log('ğŸ§ª DÃ©but des tests Supabase...')
    
    const tests = [
      { name: 'Connexion', fn: () => this.testConnection() },
      { name: 'CrÃ©ation entreprise', fn: () => this.testCreateCompany() },
      { name: 'Migration', fn: () => this.testMigration() }
    ]

    let passed = 0
    let failed = 0

    for (const test of tests) {
      try {
        const result = await test.fn()
        if (result) {
          passed++
        } else {
          failed++
        }
      } catch (error) {
        console.error(`âŒ Test ${test.name} Ã©chouÃ©:`, error)
        failed++
      }
    }

    console.log(`\nğŸ“Š RÃ©sultats des tests:`)
    console.log(`âœ… RÃ©ussis: ${passed}`)
    console.log(`âŒ Ã‰chouÃ©s: ${failed}`)
    console.log(`ğŸ“ˆ Taux de rÃ©ussite: ${Math.round((passed / (passed + failed)) * 100)}%`)
  }
}

// Fonction globale pour lancer les tests depuis la console
if (typeof window !== 'undefined') {
  (window as any).testSupabase = SupabaseTest.runAllTests
}
